<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Itsy Bitsy</title>
    <link href="./styles.css" rel="stylesheet">
    <link href="./custom.css" rel="stylesheet">
  </head>
  <body class="font-sans max-w-2xl mx-auto px-5 py-10 leading-relaxed">
    <h1 class="text-3xl font-bold text-gray-900">Itsy Bitsy Agent</h1>
    <p class="text-gray-600 text-lg -mt-2 mb-8">A tiny, bookmarklet-based agent.</p>

    <div class="bg-gray-50 border border-gray-200 rounded-lg p-5 my-5">
      <p class="font-semibold">Drag this bookmarklet to your bookmarks bar:</p>

      <div class="text-center my-5">
        <a
          href="javascript:(function(){if(window.bookmarkletAgent){window.bookmarkletAgent.toggle();return;}const script=document.createElement('script');script.src=window.location.origin+'/agent.js?t='+Date.now();script.onload=function(){if(window.bookmarkletAgent){window.bookmarkletAgent.init();}};script.onerror=function(){alert('Itsy Bitsy failed to load. This website may have Content Security Policy (CSP) restrictions that block external scripts. Try using the bookmarklet on a different website.');};try{document.head.appendChild(script);}catch(e){alert('Itsy Bitsy failed to load. This website may have Content Security Policy (CSP) restrictions. Error: '+e.message);}})();"
          id="main-bookmarklet"
          class="inline-block bg-blue-600 hover:bg-blue-700 text-white px-5 py-3 rounded-md font-medium cursor-move"
          >üï∑Ô∏è Itsy Bitsy</a
        >
      </div>

      <div class="bg-blue-50 border border-blue-200 rounded-lg my-5 overflow-hidden" id="mobile-instructions">
        <div class="p-4 cursor-pointer flex justify-between items-center select-none hover:bg-blue-100" onclick="toggleMobileInstructions()">
          <h4 class="text-blue-700 font-semibold m-0">üì± Mobile Safari Instructions</h4>
          <span class="text-blue-700 text-xs transition-transform duration-200">‚ñº</span>
        </div>
        <div class="px-4 pb-4 mobile-content">
          <p class="text-sm">
            On mobile Safari, you can't drag bookmarklets. Here are two ways to
            use it:
          </p>

          <div class="bg-gray-50 border border-gray-200 rounded p-3 my-4 text-center">
            <p class="text-sm font-semibold mb-2">First, copy the bookmarklet code:</p>
            <button onclick="copyBookmarklet()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded text-sm">
              üìã Copy Bookmarklet
            </button>
          </div>

          <h5 class="text-gray-700 text-sm font-semibold mt-4 mb-2">Method 1: Edit Existing Bookmark</h5>
          <ol class="text-sm my-2 pl-5 space-y-1">
            <li>Create a regular bookmark for any website</li>
            <li>Go to Bookmarks ‚Üí Edit</li>
            <li>Tap the bookmark you created</li>
            <li>Tap the URL field and paste the bookmarklet code</li>
            <li>Save the bookmark</li>
          </ol>

          <h5 class="text-gray-700 text-sm font-semibold mt-4 mb-2">Method 2: Sync from Mac Safari</h5>
          <ol class="text-sm my-2 pl-5 space-y-1">
            <li>On your Mac, drag the bookmarklet to Safari's bookmarks bar</li>
            <li>Make sure iCloud sync is enabled for Safari</li>
            <li>
              The bookmarklet will appear on your iPhone/iPad automatically
            </li>
          </ol>
        </div>
      </div>

      <div class="mt-5 pt-4 border-t border-gray-200">
        <label for="api-key-input" class="block mb-2 text-sm font-medium">
          Embed Anthropic API key in bookmarklet (optional)
        </label>
        <p class="text-sm text-gray-600 mb-3">
          Get your API key from
          <a
            href="https://console.anthropic.com/"
            target="_blank"
            rel="noopener"
            class="text-blue-600 hover:underline"
            >Anthropic Console</a
          >. This allows the agent to work without requiring you to enter your
          key each time.
        </p>
        <textarea
          id="api-key-input"
          placeholder="Enter your Anthropic API key (sk-...)"
          oninput="updateBookmarklet()"
          class="w-full h-15 p-2 border border-gray-300 rounded text-sm font-mono resize-y"
        ></textarea>
      </div>
    </div>

    <div class="mt-15 pt-5 border-t border-gray-200 text-gray-600 text-sm">
      <h3 class="text-gray-900 text-base font-semibold mt-0">Security & Privacy</h3>
      <p>
        This page doesn't see the websites you visit or save your API key. Your
        API key is stored in your bookmarklet and/or browser's local storage.
        However, websites you use the bookmarklet on could potentially detect
        that you're using it and access your API key.
      </p>
      <h3 class="text-gray-900 text-base font-semibold mt-4">Compatibility</h3>
      <p>
        Web pages can provide a Content Security Policy that may prevent the
        bookmarklet from working. Chrome's developer tools can override CSP if
        you're adventurous.
      </p>
    </div>

    <footer class="mt-10 pt-5 border-t border-gray-200 text-gray-500 text-xs text-center">
      <p>Built {{BUILD_TIME}} (v{{CACHE_HASH}})</p>
    </footer>

    <script>
      function updateBookmarklet() {
        const apiKey = document.getElementById("api-key-input").value.trim();
        const bookmarkletLink = document.getElementById("main-bookmarklet");
        const baseUrl = window.location.origin;

        if (!apiKey) {
          // Reset to base bookmarklet if no API key
          const baseCode = `javascript:(function(){if(window.bookmarkletAgent){window.bookmarkletAgent.toggle();return;}const script=document.createElement('script');script.src='${baseUrl}/agent.js?t='+Date.now();script.onload=function(){if(window.bookmarkletAgent){window.bookmarkletAgent.init();}};script.onerror=function(){alert('Itsy Bitsy failed to load. This website may have Content Security Policy (CSP) restrictions that block external scripts. Try using the bookmarklet on a different website.');};try{document.head.appendChild(script);}catch(e){alert('Itsy Bitsy failed to load. This website may have Content Security Policy (CSP) restrictions. Error: '+e.message);}})();`;
          bookmarkletLink.href = baseCode;
          return;
        }

        // Create bookmarklet with embedded API key
        const bookmarkletCode = `javascript:(function(){if(window.bookmarkletAgent){window.bookmarkletAgent.toggle();return;}window.BOOKMARKLET_API_KEY='${apiKey}';const script=document.createElement('script');script.src='${baseUrl}/agent.js?t='+Date.now();script.onload=function(){if(window.bookmarkletAgent){window.bookmarkletAgent.init();}};script.onerror=function(){alert('Itsy Bitsy failed to load. This website may have Content Security Policy (CSP) restrictions that block external scripts. Try using the bookmarklet on a different website.');};try{document.head.appendChild(script);}catch(e){alert('Itsy Bitsy failed to load. This website may have Content Security Policy (CSP) restrictions. Error: '+e.message);}})();`;
        bookmarkletLink.href = bookmarkletCode;
      }

      function copyBookmarklet() {
        const bookmarkletLink = document.getElementById("main-bookmarklet");
        const bookmarkletCode = bookmarkletLink.href;

        navigator.clipboard
          .writeText(bookmarkletCode)
          .then(function () {
            const button = document.querySelector(".copy-button");
            const originalText = button.textContent;
            button.textContent = "‚úÖ Copied!";
            button.style.background = "#28a745";

            setTimeout(function () {
              button.textContent = originalText;
              button.style.background = "#28a745";
            }, 2000);
          })
          .catch(function (err) {
            console.error("Failed to copy: ", err);
            alert(
              "Failed to copy bookmarklet. Please try selecting and copying manually."
            );
          });
      }

      function toggleMobileInstructions() {
        const mobileInstructions = document.getElementById(
          "mobile-instructions"
        );
        mobileInstructions.classList.toggle("collapsed");
      }
    </script>
  </body>
</html>
